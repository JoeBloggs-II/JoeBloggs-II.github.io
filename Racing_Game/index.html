<script>
  const API_KEY = "Nllp5A.3TYLaQ:G74XydAZRQIJ0-IwWsjhBj6HNcaeiYjdyWUc4zq1TiE";
  const ably = new Ably.Realtime(API_KEY);
  const channel = ably.channels.get("racing-room");

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const carImage = new Image();
  carImage.src = "assets/red_car.svg";
  const carOtherImage = new Image();
  carOtherImage.src = "assets/blue_car.svg";

  const me = {
    id: Math.random().toString(36).substr(2, 5),
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    angle: 0,
    speed: 0,
    keys: {}
  };
  const others = {};

  document.addEventListener("keydown", e => me.keys[e.key] = true);
  document.addEventListener("keyup", e => me.keys[e.key] = false);

  // Mobile controls
  const controls = {
    left: document.getElementById("left"),
    right: document.getElementById("right"),
    up: document.getElementById("up"),
    down: document.getElementById("down")
  };
  Object.entries(controls).forEach(([dir, btn]) => {
    btn.addEventListener("touchstart", () => me.keys[dir] = true);
    btn.addEventListener("touchend", () => me.keys[dir] = false);
  });

  function update() {
    if (me.keys["ArrowUp"] || me.keys["w"] || me.keys.up) me.speed += 0.2;
    if (me.keys["ArrowDown"] || me.keys["s"] || me.keys.down) me.speed -= 0.2;
    if (me.keys["ArrowLeft"] || me.keys["a"] || me.keys.left) me.angle -= 0.05;
    if (me.keys["ArrowRight"] || me.keys["d"] || me.keys.right) me.angle += 0.05;

    me.speed *= 0.98;
    me.x += Math.cos(me.angle) * me.speed;
    me.y += Math.sin(me.angle) * me.speed;

    channel.publish("player-state", {
      id: me.id,
      x: me.x,
      y: me.y,
      angle: me.angle
    });
  }

  channel.subscribe("player-state", msg => {
    const { id, x, y, angle } = msg.data;
    if (id !== me.id) {
      if (!others[id]) others[id] = { history: [] };
      others[id].history.push({ x, y, angle, time: Date.now() });
      if (others[id].history.length > 10) others[id].history.shift();
    }
  });

  function getInterpolatedState(history) {
    const renderTime = Date.now() - 100; // 100ms delay for interpolation
    if (history.length < 2) return history[0];

    for (let i = history.length - 2; i >= 0; i--) {
      const older = history[i];
      const newer = history[i + 1];
      if (older.time <= renderTime && newer.time >= renderTime) {
        const t = (renderTime - older.time) / (newer.time - older.time);
        return {
          x: older.x + (newer.x - older.x) * t,
          y: older.y + (newer.y - older.y) * t,
          angle: older.angle + (newer.angle - older.angle) * t
        };
      }
    }
    // No newer point? extrapolate from last two
    const last = history[history.length - 1];
    const secondLast = history[history.length - 2];
    const dt = (last.time - secondLast.time) || 1;
    const vx = (last.x - secondLast.x) / dt;
    const vy = (last.y - secondLast.y) / dt;
    const va = (last.angle - secondLast.angle) / dt;
    const extrapolation = (renderTime - last.time);
    return {
      x: last.x + vx * extrapolation,
      y: last.y + vy * extrapolation,
      angle: last.angle + va * extrapolation
    };
  }

  function drawCar(x, y, angle, image) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    ctx.drawImage(image, -48, -23.8, 96, 47.6);
    ctx.restore();
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawCar(me.x, me.y, me.angle, carImage);

    for (const id in others) {
      const state = getInterpolatedState(others[id].history);
      if (state) drawCar(state.x, state.y, state.angle, carOtherImage);
    }
  }

  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>
