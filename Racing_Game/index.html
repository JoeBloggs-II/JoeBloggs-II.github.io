<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Turbo Trackers â€” Arcade Drift Multiplayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body { margin:0; overflow:hidden; background:#111; height:100%; }
  canvas { display:block; background:#202225; width:100vw; height:100vh; }
  #hud {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    display:flex; gap:16px; color:#fff; font-family:system-ui, sans-serif;
    font-size:14px; font-weight:700; z-index:10; flex-wrap:wrap; justify-content:center;
  }
  .bar { display:flex; align-items:center; gap:6px; }
  .bar .name { opacity:0.8; min-width:54px; text-align:right; }
  .bar .track { width:140px; height:12px; background:#3a3d41; border:1px solid #9aa0a6; border-radius:6px; overflow:hidden; }
  .bar .fill { height:100%; width:100%; background:linear-gradient(90deg, #33ff66, #aaff33); }

  #deadScreen { position:absolute; inset:0; display:none; z-index:20;
    background:rgba(0,0,0,0.72); color:#fff; font-family:system-ui, sans-serif;
    align-items:center; justify-content:center; flex-direction:column; gap:16px;
    text-align:center; padding:24px;
  }
  #deadScreen .title { font-size:28px; font-weight:800; letter-spacing:0.5px; }
  #deadScreen .sub { font-size:18px; opacity:0.9; }
</style>
</head>
<body>

<!-- HUD + Dead overlay -->
<div id="hud"></div>
<div id="deadScreen">
  <div class="title" id="killerText"></div>
  <div class="sub" id="respawnText"></div>
</div>

<!-- Game canvas -->
<canvas id="game"></canvas>

<!-- Ably -->
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<script>
/* =========================
   CHAT UI (button + sidebar)
   ========================= */
const chatBtn = document.createElement("div");
chatBtn.id = "chatBtn";
chatBtn.style = `
  position:absolute; top:12px; right:12px;
  width:32px; height:28px; cursor:pointer; z-index:15;
  display:flex; flex-direction:column; justify-content:space-around;
  padding:4px; background:rgba(0,0,0,0.55); border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
`;
for (let i = 0; i < 3; i++) {
  const line = document.createElement("div");
  line.style = "height:3px; background:#fff; border-radius:2px;";
  chatBtn.appendChild(line);
}
document.body.appendChild(chatBtn);

const chatSidebar = document.createElement("div");
chatSidebar.id = "chatSidebar";
chatSidebar.style = `
  position:absolute; top:0; right:-300px; width:300px; height:100%;
  background:#1d1f22; color:#fff; font-family:system-ui;
  box-shadow:-6px 0 12px rgba(0,0,0,0.35);
  display:flex; flex-direction:column; padding:10px 10px 12px 10px;
  transition:right 0.25s; z-index:14;
`;
document.body.appendChild(chatSidebar);

const chatLog = document.createElement("div");
chatLog.style = "flex:1 1 auto; overflow-y:auto; font-size:14px; line-height:1.35;";
chatSidebar.appendChild(chatLog);

const chatInput = document.createElement("input");
chatInput.placeholder = "Type message...";
chatInput.style = "flex:0 0 auto; width:100%; box-sizing:border-box; padding:8px 10px; border-radius:6px; border:none; outline:none; background:#2a2d31; color:#fff;";
chatSidebar.appendChild(chatInput);

let chatOpen = false;
chatBtn.addEventListener("click", () => {
  chatOpen = !chatOpen;
  chatSidebar.style.right = chatOpen ? "0px" : "-300px";
  if (chatOpen) setTimeout(() => chatInput.focus(), 0);
});

/* ================
   CANVAS & ASSETS
   ================ */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener("resize", resize); resize();

const carMe = new Image(); carMe.src = "assets/red_car.svg";
const carOther = new Image(); carOther.src = "assets/blue_car.svg";
const CAR_W = 96, CAR_H = 47.6;

/* ===========
   NETWORKING
   =========== */
const API_KEY = "Nllp5A.3TYLaQ:G74XydAZRQIJ0-IwWsjhBj6HNcaeiYjdyWUc4zq1TiE";
const ROOM = "racing-room";
const ably = new Ably.Realtime(API_KEY);
const channel = ably.channels.get(ROOM);

/* ==================
   USERNAME COOKIE
   ================== */
function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m[2]:null; }
let username = getCookie("tt_username");
if(!username){ username = prompt("Enter your username:","You") || "You"; document.cookie = `tt_username=${username};path=/;max-age=${60*60*24*365}`; }

/* =================
   WORLD
   ================= */
const WORLD_W = 5000;
const WORLD_H = 5000;

// Out-of-bounds handling
const OOB_LIMIT = 5; // seconds outside world before kill

// Decorative/static obstacles (simple rectangles)
const obstacles = [
  {x: 450,  y: 700,  w: 240, h: 50},
  {x: 1400, y: 1200, w: 120, h: 160},
  {x: 2300, y: 900,  w: 200, h: 60},
  {x: 3300, y: 2200, w: 140, h: 140},
  {x: 4100, y: 1100, w: 180, h: 80}
];

/* ==========
   PARTICLES
   ========== */
const particles = [];
class Particle {
  constructor(x,y,size,life,vx,vy,color){ this.x=x; this.y=y; this.size=size; this.life=life; this.vx=vx||0; this.vy=vy||0; this.color=color||"white"; this.maxLife=life; }
  update(){ this.life--; this.x+=this.vx; this.y+=this.vy; }
  draw(){ ctx.globalAlpha=Math.max(0,this.life/this.maxLife); ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
}
function burst(x,y,count,baseSpeed,color,size=3,life=30){ for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const s=baseSpeed*(0.4+0.6*Math.random()); particles.push(new Particle(x,y,size*(0.8+Math.random()*0.6),life+Math.floor(Math.random()*10),Math.cos(a)*s,Math.sin(a)*s,color)); } }

/* =========================
   PLAYERS & INPUT
   ========================= */
function rand(a,b){ return a + Math.random()*(b-a); }
const ID = Math.random().toString(36).slice(2,7);
function makePlayer(isMe){ return { id:isMe?ID:"?", name:isMe?username:"P", x:rand(CAR_W,WORLD_W-CAR_W), y:rand(CAR_H,WORLD_H-CAR_H), angle:0, vx:0, vy:0, speedCapFwd:10.0, speedCapBack:-3.0, accel:0.25, brake:0.18, baseTurn:0.04, driftTurn:0.05, gripLong:0.985, gripLat:0.80, gripLatDrift:0.95, drag:0.992, drift:false, health:100, dead:false, stunned:0, respawnTimer:0, killer:null, lastHitBy:null, oobTimer:0 }; }
const me = makePlayer(true);
const remotes = {};
const HISTORY = 24, INTERP_DELAY = 120, SEND_MS = 50;

const meKeys = {};
const keyMap = { ArrowUp:"up", ArrowDown:"down", ArrowLeft:"left", ArrowRight:"right", w:"up", a:"left", s:"down", d:"right", Shift:"drift" };
addEventListener("keydown", e=>{ if(keyMap[e.key]){ meKeys[keyMap[e.key]]=true; e.preventDefault(); } });
addEventListener("keyup", e=>{ if(keyMap[e.key]){ meKeys[keyMap[e.key]]=false; e.preventDefault(); } });

/* ==========================
   INTERPOLATION
   ========================== */
function pushHistory(obj,snap){ if(!obj.history)obj.history=[]; obj.history.push(snap); if(obj.history.length>HISTORY)obj.history.shift(); obj.lastSeen=performance.now(); }
function getInterpolatedState(history, now){ if(!history||!history.length) return null; const rt=now-INTERP_DELAY; if(rt<=history[0].t)return history[0]; for(let i=history.length-2;i>=0;i--){ const a=history[i],b=history[i+1]; if(a.t<=rt && rt<=b.t){ const f=(rt-a.t)/Math.max(1,b.t-a.t); return {x:a.x+(b.x-a.x)*f, y:a.y+(b.y-a.y)*f, angle:a.angle+(b.angle-a.angle)*f, vx:a.vx+(b.vx-a.vx)*f, vy:a.vy+(b.vy-a.vy)*f, speed:a.speed+(b.speed-a.speed)*f, t:rt}; } } return history[history.length-1]; }

/* =====
   HUD
   ===== */
const hud = document.getElementById("hud");
function rebuildHUD(){ hud.innerHTML=""; const everyone=[me,...Object.values(remotes).map(r=>r.state)]; everyone.forEach(p=>{ const wrap=document.createElement("div"); wrap.className="bar"; const name=document.createElement("div"); name.className="name"; name.textContent=(p.name||p.id).slice(0,6); const track=document.createElement("div"); track.className="track"; const fill=document.createElement("div"); fill.className="fill"; fill.id="hp-"+p.id; track.appendChild(fill); wrap.appendChild(name); wrap.appendChild(track); hud.appendChild(wrap); }); }
function updateHUDValues(){ const setFill=(id,hp)=>{ const el=document.getElementById("hp-"+id); if(el)el.style.width=Math.max(0,Math.min(100,hp))+"%"; }; setFill(me.id,me.health); for(const id in remotes)setFill(id,remotes[id].state.health); }
rebuildHUD();

/* =================
   DEAD OVERLAY
   ================= */
const deadScreen = document.getElementById("deadScreen");
const killerText = document.getElementById("killerText");
const respawnText = document.getElementById("respawnText");
function showDeadOverlay(show){ deadScreen.style.display=show?"flex":"none"; }

/* =========================
   CAMERA / BORDER / RADAR
   ========================= */
function getCameraOffset(){
  let camX = me.x - canvas.width/2;
  let camY = me.y - canvas.height/2;
  camX = Math.max(0, Math.min(camX, WORLD_W - canvas.width));
  camY = Math.max(0, Math.min(camY, WORLD_H - canvas.height));
  return {camX, camY};
}
  
/* =====================
   DRAW CAR + NAMETAGS
   ===================== */
function drawCar(x,y,angle,slip,image,name){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(angle+slip*0.1);
  ctx.drawImage(image,-CAR_W/2,-CAR_H/2,CAR_W,CAR_H);
  ctx.restore();
  // name tag
  if(name){
    ctx.fillStyle="#fff"; ctx.font="bold 16px system-ui"; ctx.textAlign="center"; ctx.fillText(name,x,y-CAR_H/2-8);
  }
}

  /* ============================
   LOCAL PHYSICS / MOVEMENT
   ============================ */
function updateLocal(dt){
  const fwdX = Math.cos(me.angle), fwdY = Math.sin(me.angle);
  const sideX = -fwdY, sideY = fwdX;

  if (!me.dead){
    if (me.stunned > 0){
      me.stunned -= dt*60;
    } else {
      if (meKeys.up){ me.vx += fwdX * me.accel * 60 * dt; me.vy += fwdY * me.accel * 60 * dt; }
      if (meKeys.down){ me.vx -= fwdX * me.brake * 60 * dt * 0.7; me.vy -= fwdY * me.brake * 60 * dt * 0.7; }

      const speed = Math.hypot(me.vx, me.vy);
      const turnBase = me.baseTurn * (0.6 + 0.4*Math.min(1, speed/6));
      const drifting = !!meKeys.drift && speed > 1.2;
      me.drift = drifting;
      const turn = drifting ? (turnBase + me.driftTurn) : turnBase;
      if (meKeys.left)  me.angle -= turn * 60 * dt;
      if (meKeys.right) me.angle += turn * 60 * dt;

      // lateral drift push
      if (drifting){ me.vx += sideX * 0.06 * 60 * dt; me.vy += sideY * 0.06 * 60 * dt; }
    }
  }

  // velocity decomposition
  const vLong = me.vx * fwdX + me.vy * fwdY;
  const vLat  = me.vx * sideX + me.vy * sideY;
  const cappedLong = Math.max(me.speedCapBack, Math.min(me.speedCapFwd, vLong));
  const latGrip = me.drift ? me.gripLatDrift : me.gripLat;
  const newVLong = cappedLong * me.gripLong;
  const newVLat  = vLat * latGrip;
  me.vx = fwdX * newVLong + sideX * newVLat;
  me.vy = fwdY * newVLong + sideY * newVLat;
  me.vx *= me.drag; me.vy *= me.drag;

  // move
  me.x += me.vx * 60 * dt; me.y += me.vy * 60 * dt;

  // exhaust particles
  if (!me.dead && Math.hypot(me.vx,me.vy) > 0.5 && Math.random() < 0.25){
    particles.push(new Particle(
      me.x - fwdX*20 + (Math.random()-0.5)*6,
      me.y - fwdY*20 + (Math.random()-0.5)*6,
      2, 16, (-fwdX + (Math.random()-0.5))*0.6, (-fwdY + (Math.random()-0.5))*0.6, "rgba(220,220,220,1)"
    ));
  }

  // drift sparks
  const slipMag = Math.abs(vLat);
  if (me.drift && slipMag > 0.6 && Math.random() < 0.5){
    const backX = me.x - fwdX * 26, backY = me.y - fwdY * 26;
    burst(backX, backY, 1, 1.4, "orange", 2, 14);
  }

  // border kill
  checkBorderKill(me);

  return slipMag;
}

  /* ====================
   MAIN LOOP
   ==================== */
let lastTime = performance.now();
function loop(now){
  const dt=(now-lastTime)/1000; lastTime=now;

  // Physics
  updateLocal(dt);

  // Clear
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Camera
  const {camX,camY}=getCameraOffset();
  ctx.save();
  ctx.translate(-camX,-camY);

  // Border
  drawBorder();

  // Obstacles
  ctx.fillStyle="#555"; obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));

  // Remotes
  for(const id in remotes){
    const r=remotes[id];
    const interp=getInterpolatedState(r.history,performance.now());
    if(!interp)continue; r.state.x=interp.x; r.state.y=interp.y; r.state.angle=interp.angle; drawCar(interp.x,interp.y,interp.angle,0,carOther,r.state.name);
  }

  // Player
  if(!me.dead) drawCar(me.x,me.y,me.angle,0,carMe,me.name);

  // Particles
  particles.forEach(p=>{ p.update(); p.draw(); });
  for(let i=particles.length-1;i>=0;i--){ if(particles[i].life<=0)particles.splice(i,1); }

  ctx.restore();

  // HUD
  updateHUDValues();

  // Radar
  drawRadar();

  requestAnimationFrame(loop);
}
loop(performance.now());

/* ===========================
   ABLY PUBLISH / SUBSCRIBE
   =========================== */
channel.subscribe(msg=>{
  if(msg.clientId===ID)return;
  if(!remotes[msg.clientId])remotes[msg.clientId]=makePlayer(false);
  const r=remotes[msg.clientId]; r.state={...msg.data,state:msg.data}; pushHistory(r,msg.data);
});

setInterval(()=>{ if(!me.dead){ channel.publish({name:username,id:ID,x:me.x,y:me.y,angle:me.angle,vx:me.vx,vy:me.vy,health:me.health}); } }, SEND_MS);

/* =========================
   RESPAWN LOGIC
   ========================= */
setInterval(()=>{
  if(me.dead){
    me.respawnTimer-=1;
    if(me.respawnTimer<=0){
      me.dead=false; me.health=100; me.x=WORLD_W/2; me.y=WORLD_H/2; me.oobTimer=0; showDeadOverlay(false);
    } else { respawnText.textContent="Respawning in "+Math.ceil(me.respawnTimer)+"s..."; }
  }
},1000);

/* =======================
   PREVENT PAGE SCROLLING
   ======================= */
window.addEventListener("keydown",e=>{ if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key))e.preventDefault(); },false);
</script>
</body>
</html>
